<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/supercluster@7.1.5/dist/supercluster.min.js"></script>
<script>
(async function(){
  const res = await fetch('places.geojson');
  const gj = await res.json();

  // --- FIX: robust tag normalization ---
  function normalizeTags(val){
    if (!val) return [];
    if (Array.isArray(val)) return val.map(t => String(t||'').toLowerCase().trim()).filter(Boolean);
    if (typeof val === 'string'){
      // try JSON first, then split on common separators
      let arr = null;
      try { const parsed = JSON.parse(val); if (Array.isArray(parsed)) arr = parsed; } catch(e){}
      if (!arr) arr = val.split(/[;,|/]/);
      return arr.map(t => String(t||'').toLowerCase().trim()).filter(Boolean);
    }
    return [];
  }

  const index = new Supercluster({ radius: 60, maxZoom: 17 }).load(
    gj.features
      .filter(f => f && f.geometry && Array.isArray(f.geometry.coordinates))
      .map(f => ({ type:'Feature', geometry:f.geometry, properties:{...f.properties} }))
  );

  const map = L.map('map', { zoomControl: true }).setView([41.387, 2.17], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'© OpenStreetMap contributors'
  }).addTo(map);

  const layer = L.layerGroup().addTo(map);

  function render() {
    layer.clearLayers();
    const b = map.getBounds();
    const bbox = [b.getWest(), b.getSouth(), b.getEast(), b.getNorth()];
    const zoom = map.getZoom();
    const activeChip = document.querySelector('.chip.active');
    const tag = activeChip ? activeChip.dataset.tag : 'all';

    const clusters = index.getClusters(bbox, zoom);
    clusters.forEach(c => {
      const coords = c.geometry && c.geometry.coordinates;
      if (!coords || coords.length !== 2) return;

      const [lng, lat] = coords;

      if (c.properties && c.properties.cluster) {
        const count = c.properties.point_count;
        const m = L.marker([lat, lng], { title:`${count} places` });
        m.on('click', () => map.setView([lat, lng], Math.min(zoom+2, 18)));
        m.bindPopup(`<strong>${count}</strong> places here`);
        m.addTo(layer);
        return;
      }

      const p = c.properties || {};
      // --- FIX: use normalized tags for filtering ---
      const tags = normalizeTags(p.tags);
      if (tag !== 'all' && !tags.includes(tag.toLowerCase())) return;

      const m = L.marker([lat, lng]);

      // prefer website → then maps_url → then url
      const primaryLink = p.website || p.maps_url || p.url;
      const links = [
        p.website ? `<a href="${p.website}" target="_blank" rel="noopener">Website</a>` : "",
        p.maps_url ? `<a href="${p.maps_url}" target="_blank" rel="noopener">Google Maps</a>` : "",
        p.menu_url ? `<a href="${p.menu_url}" target="_blank" rel="noopener">Menu</a>` : "",
        p.reservation_url ? `<a href="${p.reservation_url}" target="_blank" rel="noopener">Reserve</a>` : ""
      ].filter(Boolean).join(" · ");

      const price = p.price ? `<span>${p.price}</span> · ` : '';
      const rating = (p.rating || p.rating === 0) ? `⭐ ${p.rating}` : '';
      const addr = p.address ? `<small>${p.address}</small><br/>` : '';
      const phone = p.phone ? `<div>📞 ${p.phone}</div>` : '';

      m.bindPopup(`
        <div style="min-width:240px">
          <strong>${p.name||'Untitled'}</strong><br/>
          ${addr}
          ${price}${rating}<br/>
          ${phone}
          ${links || (primaryLink ? `<a href="${primaryLink}" target="_blank" rel="noopener">Open</a>` : '')}
        </div>
      `);
      m.addTo(layer);
    });
  }

  // fit map to all features safely
  const coords = gj.features
    .filter(f => f.geometry && Array.isArray(f.geometry.coordinates))
    .map(f => [f.geometry.coordinates[1], f.geometry.coordinates[0]]);
  if (coords.length) map.fitBounds(L.latLngBounds(coords), { padding:[24,24] });

  map.on('moveend zoomend', render);
  render();

  // filter chips
  document.querySelectorAll('.chip').forEach(ch => {
    ch.addEventListener('click', () => {
      document.querySelectorAll('.chip').forEach(x => x.classList.remove('active'));
      ch.classList.add('active');
      render();
    });
  });
  document.querySelector('[data-tag="all"]').classList.add('active');
})();
</script>
