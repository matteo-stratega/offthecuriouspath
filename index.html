<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hidden Gems BCN</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html,body,#app{height:100%;margin:0}
    #map{height:100%}
    .toolbar{position:absolute;z-index:1000;top:12px;left:12px;background:#fff;padding:8px 10px;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.12);font:14px system-ui}
    .chip{display:inline-block;margin:2px 6px 0 0;padding:6px 10px;border-radius:999px;background:#f3f4f6;cursor:pointer}
    .chip.active{background:#111;color:#fff}
    .legend{position:absolute;z-index:1000;bottom:12px;left:12px;background:#fff;padding:8px 10px;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.12);font:12px system-ui}
  </style>
</head>
<body>
<div id="app">
  <div class="toolbar">
    <strong>Filter:</strong>
    <span class="chip" data-tag="all">All</span>
    <span class="chip" data-tag="tapas">Tapas</span>
    <span class="chip" data-tag="wine bar">Wine bar</span>
    <span class="chip" data-tag="brunch">Brunch</span>
    <span class="chip" data-tag="cocktail">Cocktail</span>
  </div>
  <div id="map"></div>
  <div class="legend">Drag/zoom ¬∑ Click markers ¬∑ Filters use substring match on tags</div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/supercluster@7.1.5/dist/supercluster.min.js"></script>
<script>
(async function(){
  const res = await fetch('places.geojson');
  const gj = await res.json();
  console.log('[map] loaded features:', (gj.features||[]).length);

  function normalizeTags(val){
    if (!val) return [];
    if (Array.isArray(val)) val = val.join(',');
    if (typeof val === 'string'){
      let arr = null;
      try { const parsed = JSON.parse(val); if (Array.isArray(parsed)) arr = parsed; } catch(e){}
      if (!arr) arr = val.split(/[;,|/]/);
      return arr.map(t => String(t||'').toLowerCase().trim()).filter(Boolean);
    }
    return [];
  }

  const rawFeatures = (gj.features||[])
    .filter(f => f && f.geometry && Array.isArray(f.geometry.coordinates));

  rawFeatures.forEach(f => {
    const p = f.properties || (f.properties = {});
    p.__tags_norm = normalizeTags(p.tags);
    p.__name_norm = String(p.name||'').toLowerCase();
  });

  const index = new Supercluster({ radius: 60, maxZoom: 17 }).load(
    rawFeatures.map(f => ({ type:'Feature', geometry:f.geometry, properties:{...f.properties} }))
  );

  const map = L.map('map', { zoomControl: true }).setView([41.387, 2.17], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'¬© OpenStreetMap contributors'
  }).addTo(map);

  const layer = L.layerGroup().addTo(map);

  function inBbox(f, bounds){
    const [lng, lat] = f.geometry.coordinates;
    return lat >= bounds.getSouth() && lat <= bounds.getNorth() &&
           lng >= bounds.getWest() && lng <= bounds.getEast();
  }

  function passesTag(f, tag){
    if (tag === 'all') return true;
    const tags = f.properties.__tags_norm || [];
    return tags.some(t => t.includes(tag.toLowerCase()));
  }

  function render() {
    layer.clearLayers();
    const bounds = map.getBounds();
    const zoom = map.getZoom();
    const activeChip = document.querySelector('.chip.active');
    const tag = activeChip ? activeChip.dataset.tag : 'all';
    console.log('[render] tag=', tag, 'zoom=', zoom);

    if (tag === 'all') {
      const bbox = [bounds.getWest(), bounds.getSouth(), bounds.getEast(), bounds.getNorth()];
      const clusters = index.getClusters(bbox, zoom);
      clusters.forEach(c => {
        const coords = c.geometry && c.geometry.coordinates;
        if (!coords) return;
        const [lng, lat] = coords;
        if (c.properties && c.properties.cluster) {
          const count = c.properties.point_count_abbreviated || c.properties.point_count;
          const m = L.marker([lat, lng], { title:`${count} places` });
          m.on('click', () => map.setView([lat, lng], Math.min(zoom+2, 18)));
          m.bindPopup(`<strong>${count}</strong> places here`);
          m.addTo(layer);
        } else {
          addPlaceMarker(c);
        }
      });
    } else {
      const filtered = rawFeatures.filter(f => inBbox(f, bounds) && passesTag(f, tag));
      console.log('[render] filtered places:', filtered.length);
      filtered.forEach(addPlaceMarker);
    }
  }

  function addPlaceMarker(f) {
    const coords = f.geometry && f.geometry.coordinates;
    if (!coords) return;
    const [lng, lat] = coords;
    const p = f.properties || {};

    const links = [
      p.website ? `<a href="${p.website}" target="_blank" rel="noopener">Website</a>` : "",
      p.maps_url ? `<a href="${p.maps_url}" target="_blank" rel="noopener">Google Maps</a>` : "",
      p.menu_url ? `<a href="${p.menu_url}" target="_blank" rel="noopener">Menu</a>` : "",
      p.reservation_url ? `<a href="${p.reservation_url}" target="_blank" rel="noopener">Reserve</a>` : ""
    ].filter(Boolean).join(" ¬∑ ");

    const price = p.price ? `<span>${p.price}</span> ¬∑ ` : '';
    const rating = (p.rating || p.rating === 0) ? `‚≠ê ${p.rating}` : '';
    const addr = p.address ? `<small>${p.address}</small><br/>` : '';
    const phone = p.phone ? `<div>üìû ${p.phone}</div>` : '';

    const m = L.marker([lat, lng]);
    m.bindPopup(`
      <div style="min-width:240px">
        <strong>${p.name||'Untitled'}</strong><br/>
        ${addr}
        ${price}${rating}<br/>
        ${phone}
        ${links}
      </div>
    `);
    m.addTo(layer);
  }

  const coords = rawFeatures.map(f => [f.geometry.coordinates[1], f.geometry.coordinates[0]]);
  if (coords.length) map.fitBounds(L.latLngBounds(coords), { padding:[24,24] });

  map.on('moveend zoomend', render);
  render();

  document.querySelectorAll('.chip').forEach(ch => {
    ch.addEventListener('click', () => {
      document.querySelectorAll('.chip').forEach(x => x.classList.remove('active'));
      ch.classList.add('active');
      render();
    });
  });
  document.querySelector('[data-tag="all"]').classList.add('active');
})();
</script>
</body>
</html>
