<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/supercluster@7.1.5/dist/supercluster.min.js"></script>
<script>
(async function(){
  // --- try multiple paths so GitHub Pages subpaths don't break fetch ---
  const candidates = [
    'places.geojson',
    (location.pathname.replace(/\/index\.html?$/,'').replace(/\/$/,'') + '/places.geojson')
  ].filter(Boolean);

  async function loadGeo() {
    let lastErr = null;
    for (const u of candidates) {
      try {
        const r = await fetch(u, { cache: 'no-store' });
        if (!r.ok) throw new Error(`HTTP ${r.status} for ${u}`);
        const j = await r.json();
        if (!j || !Array.isArray(j.features)) throw new Error('Invalid GeoJSON');
        console.log('[geo] loaded', j.features.length, 'features from', u);
        return j;
      } catch (e) { lastErr = e; console.warn('[geo] failed', u, e); }
    }
    throw lastErr || new Error('Could not load places.geojson');
  }

  function normalizeTags(val){
    if (!val) return [];
    if (Array.isArray(val)) val = val.join(',');
    if (typeof val === 'string'){
      let arr = null;
      try { const parsed = JSON.parse(val); if (Array.isArray(parsed)) arr = parsed; } catch(e){}
      if (!arr) arr = val.split(/[;,|/]/);
      return arr.map(t => String(t||'').toLowerCase().trim()).filter(Boolean);
    }
    return [];
  }

  let gj;
  try { gj = await loadGeo(); }
  catch (e) {
    document.body.insertAdjacentHTML('beforeend',
      `<div style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;font:16px system-ui;background:#fff">
         <div style="max-width:680px;padding:24px;border:1px solid #eee;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.08)">
           <b>Failed to load <code>places.geojson</code></b><br>
           <div style="margin-top:8px;color:#666">${String(e)}</div>
           <div style="margin-top:12px">Make sure <code>places.geojson</code> sits next to <code>index.html</code> in the repo root, and visit it directly in the browser to confirm.</div>
         </div>
       </div>`);
    console.error(e);
    return;
  }

  const rawFeatures = (gj.features||[])
    .filter(f => f && f.geometry && Array.isArray(f.geometry.coordinates));

  rawFeatures.forEach(f => {
    const p = f.properties || (f.properties = {});
    p.__tags_norm = normalizeTags(p.tags);
  });

  const index = new Supercluster({ radius: 60, maxZoom: 17 }).load(
    rawFeatures.map(f => ({ type:'Feature', geometry:f.geometry, properties:{...f.properties} }))
  );

  const map = L.map('map', { zoomControl: true }).setView([41.387, 2.17], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'¬© OpenStreetMap contributors'
  }).addTo(map);

  const layer = L.layerGroup().addTo(map);

  function inBbox(f, b){
    const [lng, lat] = f.geometry.coordinates;
    return lat >= b.getSouth() && lat <= b.getNorth() && lng >= b.getWest() && lng <= b.getEast();
  }
  function passesTag(f, tag){
    if (tag === 'all') return true;
    const tags = f.properties.__tags_norm || [];
    return tags.some(t => t.includes(tag.toLowerCase()));
  }

  function addPlaceMarker(f) {
    const [lng, lat] = f.geometry.coordinates;
    const p = f.properties || {};
    const links = [
      p.website ? `<a href="${p.website}" target="_blank" rel="noopener">Website</a>` : "",
      p.maps_url ? `<a href="${p.maps_url}" target="_blank" rel="noopener">Google Maps</a>` : "",
      p.menu_url ? `<a href="${p.menu_url}" target="_blank" rel="noopener">Menu</a>` : "",
      p.reservation_url ? `<a href="${p.reservation_url}" target="_blank" rel="noopener">Reserve</a>` : ""
    ].filter(Boolean).join(" ¬∑ ");
    const price = p.price ? `<span>${p.price}</span> ¬∑ ` : '';
    const rating = (p.rating || p.rating === 0) ? `‚≠ê ${p.rating}` : '';
    const addr = p.address ? `<small>${p.address}</small><br/>` : '';
    const phone = p.phone ? `<div>üìû ${p.phone}</div>` : '';
    L.marker([lat, lng]).bindPopup(`
      <div style="min-width:240px">
        <strong>${p.name||'Untitled'}</strong><br/>
        ${addr}${price}${rating}<br/>${phone}${links}
      </div>`).addTo(layer);
  }

  function render() {
    layer.clearLayers();
    const b = map.getBounds();
    const z = map.getZoom();
    const chip = document.querySelector('.chip.active');
    const tag = chip ? chip.dataset.tag : 'all';

    if (tag === 'all') {
      const bbox = [b.getWest(), b.getSouth(), b.getEast(), b.getNorth()];
      index.getClusters(bbox, z).forEach(c => {
        const [lng, lat] = c.geometry.coordinates;
        if (c.properties.cluster) {
          const cnt = c.properties.point_count_abbreviated || c.properties.point_count;
          const m = L.marker([lat, lng], { title:`${cnt} places` });
          m.on('click', () => map.setView([lat, lng], Math.min(z+2, 18)));
          m.bindPopup(`<strong>${cnt}</strong> places here`).addTo(layer);
        } else { addPlaceMarker(c); }
      });
    } else {
      rawFeatures.filter(f => inBbox(f, b) && passesTag(f, tag)).forEach(addPlaceMarker);
    }
  }

  if (rawFeatures.length) {
    const coords = rawFeatures.map(f => [f.geometry.coordinates[1], f.geometry.coordinates[0]]);
    map.fitBounds(L.latLngBounds(coords), { padding:[24,24] });
  }
  map.on('moveend zoomend', render);
  render();

  document.querySelectorAll('.chip').forEach(ch => {
    ch.addEventListener('click', () => {
      document.querySelectorAll('.chip').forEach(x => x.classList.remove('active'));
      ch.classList.add('active');
      render();
    });
  });
  document.querySelector('[data-tag="all"]').classList.add('active');
})();
</script>
